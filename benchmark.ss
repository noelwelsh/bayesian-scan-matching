#lang scheme/base

(require
 (planet schematics/benchmark:2)
 (planet schematics/icp:1/point)
 (planet schematics/numeric:1/vector)
  "base.ss"
  "grid.ss"
  "grid-scan.ss"
  "place.ss"
  "scan-match.ss")

;; A scan from the Freiburg data set
(define example-scan
  (vector (make-polar 1.69 -3.141592653589793) (make-polar 1.58 -3.12413936106985) (make-polar 1.56 -3.106686068549907) (make-polar 1.55 -3.089232776029964) (make-polar 1.56 -3.0717794835100207) (make-polar 1.58 -3.0543261909900776) (make-polar 1.59 -3.0368728984701345) (make-polar 1.63 -3.0194196059501914) (make-polar 1.64 -3.0019663134302483) (make-polar 1.67 -2.9845130209103052) (make-polar 1.68 -2.967059728390362) (make-polar 1.73 -2.949606435870419) (make-polar 1.74 -2.932153143350476) (make-polar 1.79 -2.914699850830533) (make-polar 1.79 -2.8972465583105897) (make-polar 1.84 -2.8797932657906467) (make-polar 1.85 -2.8623399732707036) (make-polar 1.96 -2.8448866807507605) (make-polar 1.98 -2.8274333882308174) (make-polar 2.01 -2.8099800957108743) (make-polar 2.01 -2.792526803190931) (make-polar 1.99 -2.775073510670988) (make-polar 1.99 -2.757620218151045) (make-polar 1.85 -2.740166925631102) (make-polar 1.86 -2.7227136331111588) (make-polar 1.84 -2.7052603405912157) (make-polar 1.83 -2.6878070480712726) (make-polar 1.88 -2.6703537555513295) (make-polar 1.88 -2.6529004630313864) (make-polar 1.86 -2.6354471705114433) (make-polar 1.87 -2.6179938779915) (make-polar 1.85 -2.600540585471557) (make-polar 1.85 -2.583087292951614) (make-polar 1.31 -2.565634000431671) (make-polar 1.3 -2.548180707911728) (make-polar 1.2 -2.5307274153917847) (make-polar 1.2 -2.5132741228718416) (make-polar 1.19 -2.4958208303518985) (make-polar 1.18 -2.4783675378319554) (make-polar 1.18 -2.4609142453120123) (make-polar 1.18 -2.443460952792069) (make-polar 1.17 -2.426007660272126) (make-polar 1.17 -2.408554367752183) (make-polar 1.17 -2.39110107523224) (make-polar 1.17 -2.373647782712297) (make-polar 1.2 -2.3561944901923537) (make-polar 1.19 -2.3387411976724106) (make-polar 1.15 -2.3212879051524675) (make-polar 1.15 -2.3038346126325244) (make-polar 1.14 -2.2863813201125813) (make-polar 1.14 -2.2689280275926382) (make-polar 1.13 -2.251474735072695) (make-polar 1.13 -2.234021442552752) (make-polar 1.12 -2.216568150032809) (make-polar 1.12 -2.199114857512866) (make-polar 1.11 -2.1816615649929227) (make-polar 1.11 -2.1642082724729796) (make-polar 1.1 -2.1467549799530365) (make-polar 1.1 -2.1293016874330934) (make-polar 1.09 -2.1118483949131504) (make-polar 1.09 -2.0943951023932073) (make-polar 1.09 -2.076941809873264) (make-polar 1.09 -2.059488517353321) (make-polar 1.08 -2.042035224833378) (make-polar 1.09 -2.024581932313435) (make-polar 1.07 -2.0071286397934918) (make-polar 1.07 -1.9896753472735484) (make-polar 1.07 -1.9722220547536051) (make-polar 1.07 -1.9547687622336618) (make-polar 1.06 -1.9373154697137185) (make-polar 1.06 -1.9198621771937752) (make-polar 1.05 -1.9024088846738318) (make-polar 1.06 -1.8849555921538885) (make-polar 1.05 -1.8675022996339452) (make-polar 1.05 -1.8500490071140019) (make-polar 1.04 -1.8325957145940586) (make-polar 1.05 -1.8151424220741152) (make-polar 1.04 -1.797689129554172) (make-polar 1.04 -1.7802358370342286) (make-polar 1.03 -1.7627825445142853) (make-polar 1.04 -1.745329251994342) (make-polar 1.03 -1.7278759594743986) (make-polar 1.03 -1.7104226669544553) (make-polar 1.03 -1.692969374434512) (make-polar 1.03 -1.6755160819145687) (make-polar 1.03 -1.6580627893946254) (make-polar 1.03 -1.640609496874682) (make-polar 1.03 -1.6231562043547387) (make-polar 1.03 -1.6057029118347954) (make-polar 1.02 -1.588249619314852) (make-polar 1.02 -1.5707963267949088) (make-polar 1.02 -1.5533430342749655) (make-polar 1.02 -1.5358897417550221) (make-polar 1.01 -1.5184364492350788) (make-polar 1.02 -1.5009831567151355) (make-polar 1.01 -1.4835298641951922) (make-polar 1.01 -1.4660765716752489) (make-polar 1.01 -1.4486232791553055) (make-polar 1.01 -1.4311699866353622) (make-polar 1.01 -1.413716694115419) (make-polar 1.01 -1.3962634015954756) (make-polar 1.01 -1.3788101090755323) (make-polar 1.01 -1.361356816555589) (make-polar 1.0 -1.3439035240356456) (make-polar 1.01 -1.3264502315157023) (make-polar 1.0 -1.308996938995759) (make-polar 1.01 -1.2915436464758157) (make-polar 1.0 -1.2740903539558723) (make-polar 1.01 -1.256637061435929) (make-polar 1.0 -1.2391837689159857) (make-polar 1.01 -1.2217304763960424) (make-polar 1.0 -1.204277183876099) (make-polar 1.01 -1.1868238913561557) (make-polar 1.01 -1.1693705988362124) (make-polar 1.02 -1.151917306316269) (make-polar 1.02 -1.1344640137963258) (make-polar 1.02 -1.1170107212763825) (make-polar 1.02 -1.0995574287564391) (make-polar 1.02 -1.0821041362364958) (make-polar 1.02 -1.0646508437165525) (make-polar 1.03 -1.0471975511966092) (make-polar 1.03 -1.0297442586766659) (make-polar 1.03 -1.0122909661567225) (make-polar 1.03 -0.9948376736367792) (make-polar 1.04 -0.9773843811168359) (make-polar 1.03 -0.9599310885968926) (make-polar 1.03 -0.9424777960769493) (make-polar 1.02 -0.9250245035570059) (make-polar 1.03 -0.9075712110370626) (make-polar 1.03 -0.8901179185171193) (make-polar 1.03 -0.872664625997176) (make-polar 1.03 -0.8552113334772327) (make-polar 1.04 -0.8377580409572893) (make-polar 1.04 -0.820304748437346) (make-polar 1.04 -0.8028514559174027) (make-polar 1.04 -0.7853981633974594) (make-polar 1.04 -0.7679448708775161) (make-polar 1.04 -0.7504915783575727) (make-polar 1.05 -0.7330382858376294) (make-polar 1.12 -0.7155849933176861) (make-polar 1.15 -0.6981317007977428) (make-polar 1.13 -0.6806784082777995) (make-polar 1.14 -0.6632251157578561) (make-polar 1.13 -0.6457718232379128) (make-polar 1.14 -0.6283185307179695) (make-polar 1.15 -0.6108652381980262) (make-polar 1.23 -0.5934119456780829) (make-polar 2.15 -0.5759586531581395) (make-polar 2.16 -0.5585053606381962) (make-polar 2.19 -0.5410520681182529) (make-polar 2.19 -0.5235987755983096) (make-polar 2.22 -0.5061454830783663) (make-polar 2.22 -0.48869219055842295) (make-polar 2.25 -0.4712388980384796) (make-polar 2.26 -0.4537856055185363) (make-polar 2.29 -0.436332312998593) (make-polar 2.29 -0.41887902047864967) (make-polar 2.32 -0.40142572795870635) (make-polar 2.33 -0.383972435438763) (make-polar 2.36 -0.3665191429188197) (make-polar 2.38 -0.3490658503988764) (make-polar 2.4 -0.33161255787893307) (make-polar 2.41 -0.31415926535898975) (make-polar 2.44 -0.29670597283904643) (make-polar 2.45 -0.2792526803191031) (make-polar 2.5 -0.2617993877991598) (make-polar 2.5 -0.2443460952792165) (make-polar 2.54 -0.2268928027592732) (make-polar 2.55 -0.2094395102393299) (make-polar 2.57 -0.19198621771938662) (make-polar 2.58 -0.17453292519944333) (make-polar 2.61 -0.15707963267950004) (make-polar 2.61 -0.13962634015955674) (make-polar 2.58 -0.12217304763961345) (make-polar 2.58 -0.10471975511967016) (make-polar 2.54 -0.08726646259972687) (make-polar 2.54 -0.06981317007978358) (make-polar 2.53 -0.052359877559840284) (make-polar 2.55 -0.03490658503989699) (make-polar 2.59 -0.017453292519953697) (make-polar 2.61 -1.0401401961956935e-14) (make-polar 2.66 0.017453292519932894) (make-polar 2.67 0.03490658503987619) (make-polar 2.91 0.05235987755981948) (make-polar 3.08 0.06981317007976277) (make-polar 3.14 0.08726646259970607) (make-polar 3.18 0.10471975511964936) (make-polar 3.18 0.12217304763959265) (make-polar 3.19 0.13962634015953596) (make-polar 7.44 0.15707963267947925) (make-polar 7.41 0.17453292519942254) (make-polar 4.56 0.19198621771936583) (make-polar 4.54 0.20943951023930912) (make-polar 4.46 0.22689280275925242) (make-polar 4.45 0.2443460952791957) (make-polar 4.4 0.261799387799139) (make-polar 4.4 0.27925268031908235) (make-polar 4.37 0.29670597283902567) (make-polar 4.38 0.314159265358969) (make-polar 4.14 0.3316125578789123) (make-polar 4.11 0.3490658503988556) (make-polar 4.03 0.36651914291879895) (make-polar 4.04 0.38397243543874227) (make-polar 4.22 0.4014257279586856) (make-polar 4.26 0.4188790204786289) (make-polar 4.39 0.4363323129985722) (make-polar 4.43 0.45378560551851554) (make-polar 4.57 0.47123889803845886) (make-polar 4.6 0.4886921905584022) (make-polar 4.76 0.5061454830783455) (make-polar 4.81 0.5235987755982888) (make-polar 4.98 0.5410520681182321) (make-polar 5.03 0.5585053606381755) (make-polar 5.24 0.5759586531581188) (make-polar 5.32 0.5934119456780621) (make-polar 5.36 0.6108652381980054) (make-polar 5.45 0.6283185307179487) (make-polar 5.84 0.6457718232378921) (make-polar 5.92 0.6632251157578354) (make-polar 6.18 0.6806784082777787) (make-polar 6.26 0.698131700797722) (make-polar 6.61 0.7155849933176653) (make-polar 6.72 0.7330382858376087) (make-polar 6.76 0.750491578357552) (make-polar 7.03 0.7679448708774953) (make-polar 7.44 0.7853981633974386) (make-polar 7.59 0.8028514559173819) (make-polar 8.05 0.8203047484373253) (make-polar 8.11 0.8377580409572686) (make-polar 8.17 0.8552113334772119) (make-polar 8.16 0.8726646259971552) (make-polar 8.48 0.8901179185170985) (make-polar 9.76 0.9075712110370419) (make-polar 10.7 0.9250245035569852) (make-polar 11.22 0.9424777960769285) (make-polar 11.44 0.9599310885968718) (make-polar 12.24 0.9773843811168151) (make-polar 12.87 0.9948376736367585) (make-polar 13.43 1.0122909661567017) (make-polar 14.11 1.029744258676645) (make-polar 14.14 1.0471975511965883) (make-polar 17.18 1.0646508437165316) (make-polar 17.19 1.082104136236475) (make-polar 17.23 1.0995574287564183) (make-polar 17.23 1.1170107212763616) (make-polar 17.18 1.134464013796305) (make-polar 17.17 1.1519173063162482) (make-polar 31.97 1.1693705988361915) (make-polar 35.0 1.1868238913561349) (make-polar 35.0 1.2042771838760782) (make-polar 35.01 1.2217304763960215) (make-polar 35.0 1.2391837689159648) (make-polar 35.0 1.2566370614359081) (make-polar 17.14 1.2740903539558515) (make-polar 17.16 1.2915436464757948) (make-polar 17.16 1.308996938995738) (make-polar 17.16 1.3264502315156814) (make-polar 14.64 1.3439035240356247) (make-polar 14.2 1.361356816555568) (make-polar 13.66 1.3788101090755114) (make-polar 12.76 1.3962634015954547) (make-polar 10.74 1.413716694115398) (make-polar 8.13 1.4311699866353413) (make-polar 8.04 1.4486232791552847) (make-polar 8.06 1.466076571675228) (make-polar 8.0 1.4835298641951713) (make-polar 8.0 1.5009831567151146) (make-polar 0.68 1.518436449235058) (make-polar 0.67 1.5358897417550013) (make-polar 0.66 1.5533430342749446) (make-polar 0.66 1.570796326794888) (make-polar 0.64 1.5882496193148312) (make-polar 0.63 1.6057029118347745) (make-polar 0.63 1.6231562043547179) (make-polar 0.63 1.6406094968746612) (make-polar 0.63 1.6580627893946045) (make-polar 0.63 1.6755160819145478) (make-polar 0.63 1.6929693744344911) (make-polar 0.64 1.7104226669544345) (make-polar 0.64 1.7278759594743778) (make-polar 0.68 1.745329251994321) (make-polar 0.69 1.7627825445142644) (make-polar 0.71 1.7802358370342077) (make-polar 0.7 1.797689129554151) (make-polar 0.7 1.8151424220740944) (make-polar 0.69 1.8325957145940377) (make-polar 0.7 1.850049007113981) (make-polar 0.7 1.8675022996339243) (make-polar 0.71 1.8849555921538677) (make-polar 0.71 1.902408884673811) (make-polar 0.7 1.9198621771937543) (make-polar 0.71 1.9373154697136976) (make-polar 0.71 1.954768762233641) (make-polar 0.71 1.9722220547535843) (make-polar 0.71 1.9896753472735276) (make-polar 0.71 2.007128639793471) (make-polar 0.72 2.024581932313414) (make-polar 0.71 2.042035224833357) (make-polar 0.73 2.0594885173533) (make-polar 0.72 2.0769418098732433) (make-polar 0.72 2.0943951023931864) (make-polar 0.72 2.1118483949131295) (make-polar 0.73 2.1293016874330726) (make-polar 0.74 2.1467549799530157) (make-polar 0.75 2.1642082724729588) (make-polar 0.74 2.181661564992902) (make-polar 0.75 2.199114857512845) (make-polar 0.75 2.216568150032788) (make-polar 0.76 2.234021442552731) (make-polar 0.76 2.2514747350726743) (make-polar 0.76 2.2689280275926174) (make-polar 0.77 2.2863813201125605) (make-polar 0.78 2.3038346126325036) (make-polar 0.77 2.3212879051524467) (make-polar 0.77 2.3387411976723897) (make-polar 0.78 2.356194490192333) (make-polar 0.79 2.373647782712276) (make-polar 0.8 2.391101075232219) (make-polar 0.8 2.408554367752162) (make-polar 0.8 2.4260076602721052) (make-polar 0.8 2.4434609527920483) (make-polar 0.81 2.4609142453119914) (make-polar 0.81 2.4783675378319345) (make-polar 0.81 2.4958208303518776) (make-polar 0.83 2.5132741228718207) (make-polar 0.84 2.530727415391764) (make-polar 0.83 2.548180707911707) (make-polar 0.84 2.56563400043165) (make-polar 0.84 2.583087292951593) (make-polar 0.84 2.600540585471536) (make-polar 0.84 2.6179938779914793) (make-polar 0.85 2.6354471705114224) (make-polar 0.86 2.6529004630313655) (make-polar 0.87 2.6703537555513086) (make-polar 0.88 2.6878070480712517) (make-polar 0.89 2.705260340591195) (make-polar 0.89 2.722713633111138) (make-polar 0.91 2.740166925631081) (make-polar 0.91 2.757620218151024) (make-polar 0.93 2.775073510670967) (make-polar 0.93 2.7925268031909103) (make-polar 0.93 2.8099800957108534) (make-polar 0.92 2.8274333882307965) (make-polar 0.91 2.8448866807507396) (make-polar 0.91 2.8623399732706827) (make-polar 0.9 2.879793265790626) (make-polar 0.9 2.897246558310569) (make-polar 0.9 2.914699850830512) (make-polar 0.9 2.932153143350455) (make-polar 0.92 2.949606435870398) (make-polar 0.94 2.9670597283903413) (make-polar 0.95 2.9845130209102844) (make-polar 0.95 3.0019663134302275) (make-polar 0.96 3.0194196059501706) (make-polar 0.96 3.0368728984701137) (make-polar 0.97 3.0543261909900568) (make-polar 0.98 3.07177948351) (make-polar 1.0 3.089232776029943) (make-polar 1.01 3.106686068549886) (make-polar 1.01 3.124139361069829)))

;; (Vectorof Polar) -> (Vectorof Point)
(define (scan-convert scan)
  (for/vector ([_ (vector-length scan)]
               [pt (in-vector scan)])
    (let ([p (polar->cartesian pt)])
      (vector (cartesian-x p) (cartesian-y p)))))

(benchmark-case
 "bayesian-scan-matching"
 (define scan (scan-convert example-scan))
 (define grid-scan (scan->grid-scan scan unit))
 (define place (grid-scan->place grid-scan))
 (scan-match/best place (grid-scan-transform grid-scan 10 -10 1)))
